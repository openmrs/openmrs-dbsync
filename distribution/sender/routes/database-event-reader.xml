<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="out-bound-db-sync" errorHandlerRef="noErrorHandler">
        <from uri="scheduler:retry?initialDelay=1000&amp;delay=10000" />
  
		<log message="Fetching events in the staging table" loggingLevel="DEBUG" />
    
        <toD uri="jpa:DebeziumEvent?query=SELECT dE.id FROM DebeziumEvent dE ORDER BY event_time_stamp ASC" />

        <choice>
            <when>
                <simple>${body.size()} > 0</simple>
                <log message="Event count in the stating area: ${body.size()}" />

                <split parallelProcessing="false">
                    <simple>${body}</simple>
                    <setProperty name="eventItem-id">
                        <simple>${body}</simple>
                    </setProperty>
                    <log message="Loading event item with id: ${body}" />

                    <toD uri="jpa:DebeziumEvent?query=SELECT dE FROM DebeziumEvent dE WHERE dE.id = ${body}" />

                    <setProperty name="event">
                        <simple>${body[0]}</simple>
                    </setProperty>
             
             	   <log message="${exchangeProperty.event}" loggingLevel="DEBUG" />

	                <setProperty name="route-retry-count-map">
	                    <spel>#{new java.util.HashMap()}</spel>
	                </setProperty>
	                <split>
	                    <simple>{{db-event.destinations}}</simple>
	                    <script>
	                        <spel>#{getProperty('route-retry-count-map').put(body.trim(), 0)}</spel>
	                    </script>
	                </split>
	                
	                <setProperty name="table-names">
	                    <!-- We need to look up failed events for rows in both the parent and subclass tables -->
	                    <method beanType="org.openmrs.eip.component.utils.Utils" method="getTablesInHierarchy(${exchangeProperty.event.tableName})" />
	                </setProperty>
	
	                <toD uri="jpa:SenderRetryQueueItem?query=SELECT r from SenderRetryQueueItem r WHERE r.event.tableName IN (${exchangeProperty.table-names}) AND r.event.primaryKeyId='${exchangeProperty.event.primaryKeyId}'" />
	
	                <split stopOnException="true">
	                    <simple>${body}</simple>
	                    <choice>
	                        <when>
	                            <simple>${exchangeProperty.route-retry-count-map.containsKey(${body.route.trim()})} != true</simple>
	                            <throwException exceptionType="java.lang.Exception" message="No listener route found with name ${body.route.trim()}" />
	                        </when>
	                        <otherwise>
	                            <script>
	                                <spel>#{getProperty('route-retry-count-map').put(body.route, getProperty('route-retry-count-map').get(body.route.trim()) + 1)}</spel>
	                            </script>
	                        </otherwise>
	                    </choice>
	                </split>
	                
	                <log message="Route and retryCount map -> ${exchangeProperty.route-retry-count-map}" loggingLevel="DEBUG" />
	                
	                <setBody>
	                    <simple>${exchangeProperty.event}</simple>
	                </setBody>
	
	                <to uri="direct:db-event-processor" />
			        
                </split>
            </when>
            <otherwise>
                <log message="No events found in staging table" loggingLevel="DEBUG" />
            </otherwise>
        </choice>
    </route>

</routes>